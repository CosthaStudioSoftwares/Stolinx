<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stolinx - Gestão de Estoque</title>

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
    
    <!-- PWA Configuration -->
    <meta name="theme-color" content="#009688">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <script>
        // Aplica o tema imediatamente para evitar o "flash" da tela clara
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.documentElement.classList.add('dark-theme');
        }
    </script>

    <style>
        /* --- ESTILOS GLOBAIS E DE TEMA --- */
        :root {
            --color-primary: #009688; /* Teal */
            --color-danger: #ff7782;
            --color-success: #41f1b6;
            --color-warning: #ffbb55;
            --color-white: #fff;
            --color-info-dark: #7d8da1;
            --color-info-light: #dce1eb;
            --color-dark: #363949;
            --color-light: rgba(132, 139, 200, 0.18);
            --color-primary-variant: #00796B; /* Darker Teal */
            --color-dark-variant: #677483;
            --color-background: #f6f6f9;
            --card-border-radius: 2rem;
            --border-radius-1: 0.4rem;
            --border-radius-2: 0.8rem;
            --border-radius-3: 1.2rem;
            --card-padding: 1.8rem;
            --padding-1: 1.2rem;
            --box-shadow: 0 2rem 3rem var(--color-light);
        }

        .dark-theme {
            --color-background: #181a1e;
            --color-white: #202528;
            --color-dark: #edeffd;
            --color-dark-variant: #a3a6ad;
            --color-light: rgba(0, 0, 0, 0.4);
            --box-shadow: 0 2rem 3rem var(--color-light);
            --color-info-light: #484d52;
        }

        * {
            margin: 0;
            padding: 0;
            outline: 0;
            appearance: none;
            border: 0;
            text-decoration: none;
            list-style: none;
            box-sizing: border-box;
        }

        html {
            font-size: 14px;
        }

        body {
            width: 100vw;
            height: 100vh;
            font-family: 'Poppins', sans-serif;
            font-size: 0.88rem;
            background: var(--color-background);
            user-select: none;
            overflow-x: hidden;
            color: var(--color-dark);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- ESTILOS DA PÁGINA DE AUTENTICAÇÃO --- */
        .auth-main-container {
            display: none;
            grid-template-columns: 45% 55%;
            height: 100vh;
            width: 100vw;
        }

        .auth-main-container.visible {
            display: grid;
        }

        .left-panel {
            background: linear-gradient(-45deg, var(--color-primary), var(--color-primary-variant));
            color: var(--color-white);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            text-align: center;
        }

        .branding-content h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 1rem;
            letter-spacing: 1px;
        }

        .branding-content h1 .danger, .auth-form-wrapper h1 .danger {
            color: var(--color-danger);
            text-shadow: 1px 1px 5px rgba(0,0,0,0.2);
        }

        .branding-content p {
            font-size: 1.1rem;
            font-weight: 300;
            max-width: 400px;
        }

        .right-panel {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .auth-form-wrapper {
            width: 100%;
            max-width: 400px;
            background: var(--color-white);
            padding: 2.5rem;
            border-radius: var(--border-radius-2);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        
        .auth-form-wrapper h1 {
            text-align: center;
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .auth-form-wrapper p {
            text-align: center;
            color: var(--color-info-dark);
            margin-bottom: 2.5rem;
        }

        .auth-form-wrapper .input-group input {
            width: 100%;
            padding: 14px;
            border-radius: var(--border-radius-1);
            background: var(--color-background);
            border: 1px solid var(--color-info-light);
            font-family: 'Poppins', sans-serif;
            color: var(--color-dark);
            font-size: 0.95rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .auth-form-wrapper .input-group input:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 150, 136, 0.25);
        }

        .auth-form-wrapper button[type="submit"] {
            width: 100%;
            padding: 14px;
            background: var(--color-primary);
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-size: 1rem;
            font-weight: 500;
        }

        .auth-form-wrapper button[type="submit"]:hover {
            background: var(--color-primary-variant);
            transform: translateY(-2px);
        }

        .auth-toggle-link {
            display: block;
            text-align: center;
            margin-top: 1.5rem;
            color: var(--color-primary);
            cursor: pointer;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .auth-toggle-link:hover {
            text-decoration: underline;
            color: var(--color-primary-variant);
        }

        #forgot-password {
            margin-top: 1rem;
            margin-bottom: -1rem;
            font-size: 0.85rem;
            color: var(--color-dark-variant);
        }

        #auth-message {
            text-align: center;
            padding: 12px;
            border-radius: var(--border-radius-1);
            margin-bottom: 1.5rem;
            display: none;
            font-weight: 500;
            color: var(--color-white);
        }

        #auth-message.success { background-color: var(--color-success); }
        #auth-message.error { background-color: var(--color-danger); }

        #login-form, #register-form {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            transform-origin: center;
        }
        
        #register-form {
            display: none;
            opacity: 0;
            transform: scale(0.95);
        }
        
        /* --- ESTILOS PRINCIPAIS DA APLICAÇÃO --- */
        .container {
            display: none; /* Começa escondido */
            width: 96%;
            margin: 0 auto;
            gap: 1.8rem;
            grid-template-columns: 14rem auto;
        }

        .container.visible {
            display: grid;
        }

        a {
            color: var(--color-dark);
        }

        h1 {
            font-weight: 800;
            font-size: 1.8rem;
        }

        h2 {
            font-size: 1.4rem;
        }

        h3 {
            font-size: 0.87rem;
        }

        aside {
            height: 100vh;
            background: var(--color-white);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        aside .top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 1.4rem;
        }

        aside .logo {
            display: flex;
            gap: 0.8rem;
        }

        aside .logo h2 {
            font-weight: 800;
        }

        aside .logo h2 .danger {
            color: var(--color-danger);
        }

        aside .close {
            display: none;
        }

        aside .sidebar {
            display: flex;
            flex-direction: column;
            height: 86vh;
            position: relative;
            top: 3rem;
        }

        aside h3 {
            font-weight: 500;
        }

        aside .sidebar a {
            display: flex;
            color: var(--color-info-dark);
            margin-left: 2rem;
            gap: 1rem;
            align-items: center;
            position: relative;
            height: 3.7rem;
            transition: all 300ms ease;
            cursor: pointer;
        }

        aside .sidebar a span {
            font-size: 1.6rem;
            transition: all 300ms ease;
        }

        aside .sidebar a:last-child {
            position: absolute;
            bottom: 2rem;
            width: 100%;
        }

        aside .sidebar a.active {
            background: var(--color-light);
            color: var(--color-primary);
            margin-left: 0;
        }

        aside .sidebar a.active:before {
            content: '';
            width: 6px;
            height: 100%;
            background: var(--color-primary);
        }

        aside .sidebar a.active span {
            color: var(--color-primary);
        }

        aside .sidebar a:hover {
            color: var(--color-primary);
        }

        aside .sidebar a:hover span {
            margin-left: 1rem;
        }

        #theme-toggler-link.active {
            background: none;
        }

        main {
            margin-top: 1.4rem;
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        #menu-btn {
            display: none;
            background: none;
            color: var(--color-dark);
            font-size: 1.8rem;
            cursor: pointer;
        }

        #mobile-page-title {
            display: none;
        }

        .main-content {
            display: none;
        }

        .main-content.active {
            display: block;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .dashboard-filters {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .dashboard-filters select, .dashboard-filters button {
            padding: 8px 12px;
            width: auto;
        }
        
        #subscription-status {
            margin-top: 1rem;
            margin-bottom: 1rem;
            font-weight: 500;
            padding: 12px;
            border-radius: var(--border-radius-1);
            background-color: var(--color-info-light);
            text-align: center;
            transition: all 300ms ease;
        }
        .dark-theme #subscription-status {
            background-color: var(--color-dark-variant);
            color: var(--color-dark);
        }
        #subscription-status .days-remaining.primary { color: var(--color-primary); }
        #subscription-status .days-remaining.warning { color: var(--color-warning); font-weight: 600; }
        #subscription-status .days-remaining.danger { color: var(--color-danger); font-weight: 600; }


        main .insights {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.6rem;
        }

        main .insights > div {
            background: var(--color-white);
            padding: var(--card-padding);
            border-radius: var(--card-border-radius);
            margin-top: 1rem;
            box-shadow: var(--box-shadow);
            transition: all 300ms ease, background-color 0.3s ease;
        }

        main .insights > div:hover {
            box-shadow: none;
        }

        main .insights > div span {
            background: var(--color-primary);
            padding: 0.5rem;
            border-radius: 50%;
            color: #fff;
            font-size: 2rem;
        }

        main .insights > div.sales span { background: var(--color-success); }
        main .insights > div.expenses span { background: var(--color-danger); }
        main .insights > div.income span { background: var(--color-primary); }


        main .insights > div .middle {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        main .insights h3 {
            margin: 1rem 0 0.6rem;
            font-size: 1rem;
        }

        .text-muted {
            color: var(--color-info-dark);
        }

        .card {
            background: var(--color-white);
            padding: var(--card-padding);
            border-radius: var(--card-border-radius);
            box-shadow: var(--box-shadow);
            transition: all 300ms ease, background-color 0.3s ease, color 0.3s ease;
            margin-top: 1.5rem;
        }

        .card:hover {
            box-shadow: none;
        }

        .card h2 {
            margin-bottom: 1.2rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--color-info-light);
            transition: border-color 0.3s ease;
        }

        tbody tr:last-child td {
            border: none;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .low-stock-warning {
            color: var(--color-warning);
            font-weight: bold;
        }

        .vencimento-proximo {
            background-color: #fffbe6 !important;
        }
        .dark-theme .vencimento-proximo {
            background-color: #332c21 !important;
        }
        .vencimento-proximo td {
            color: #8a6d3b !important;
        }
        .dark-theme .vencimento-proximo td {
            color: #e4c489 !important;
        }
        .vencimento-aviso-icon {
            color: var(--color-warning);
            font-size: 1.2rem;
            vertical-align: middle;
            margin-left: 8px;
            cursor: help;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.6rem;
            align-items: start;
        }

        .dashboard-grid .card {
            margin-top: 0;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .form-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .form-container .input-group {
             margin-bottom: 0;
        }

        .input-group label {
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border-radius: var(--border-radius-1);
            background: var(--color-info-light);
            font-family: 'Poppins', sans-serif;
            color: var(--color-dark);
            font-size: 0.88rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        button {
            padding: 10px 20px;
            border-radius: var(--border-radius-1);
            background: var(--color-primary);
            color: #fff;
            cursor: pointer;
            transition: all 300ms ease;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        button:hover {
            opacity: 0.8;
        }

        .btn-success { background: var(--color-success); }
        .btn-danger { background: var(--color-danger); }
        .btn-warning { background: var(--color-warning); }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .action-buttons button {
            margin-right: 5px;
            padding: 5px 8px;
            width: auto;
        }

        .action-buttons .material-icons-sharp {
            font-size: 1.2rem;
            vertical-align: middle;
        }

        .search-bar {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .search-instruction {
            font-size: 0.75rem;
            color: var(--color-info-dark);
            margin-bottom: 1.5rem;
            display: block;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-container {
            background: var(--color-white);
            padding: var(--card-padding);
            border-radius: var(--card-border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-info-light);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            transition: border-color 0.3s ease;
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-header .close-modal {
            background: none;
            color: var(--color-dark);
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: auto;
        }

        #lista-categorias li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid var(--color-info-light);
            transition: border-color 0.3s ease, color 0.3s ease;
        }

        .pagination-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            padding: 0.5rem;
        }
        .pagination-button {
            background-color: var(--color-primary);
            color: var(--color-white);
            border: none;
            border-radius: var(--border-radius-1);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 300ms ease;
        }
        .pagination-button:hover {
            opacity: 0.8;
        }
        .pagination-button:disabled {
            background-color: var(--color-light);
            color: var(--color-dark-variant);
            cursor: not-allowed;
        }
        .page-info {
            font-size: 0.875rem;
            color: var(--color-dark-variant);
        }

        .total-section {
            text-align: right;
            margin-top: 1.5rem;
            border-top: 1px solid var(--color-info-light);
            padding-top: 1.5rem;
        }
        .desconto-toggle-container {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .toggle-switch {
            display: flex;
            border: 1px solid var(--color-light);
            border-radius: var(--border-radius-1);
            overflow: hidden;
        }
        .toggle-btn {
            padding: 0.5rem 1rem;
            cursor: pointer;
            background-color: transparent;
            color: var(--color-dark-variant);
            border: none;
            font-weight: 500;
            transition: all 300ms ease;
        }
        .toggle-btn.active {
            background-color: var(--color-primary);
            color: var(--color-white);
        }
        .total-section .desconto-group {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .desconto-group input { max-width: 150px; }

        .total-final { margin-top: 1rem; }

        #sugestoes-produtos-container {
            display: none;
            position: absolute;
            background-color: var(--color-white);
            border: 1px solid var(--color-light);
            border-radius: var(--border-radius-1);
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .sugestao-item {
            padding: 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--color-light);
        }
        .sugestao-item:last-child {
            border-bottom: none;
        }
        .sugestao-item:hover {
            background-color: var(--color-light);
        }

        .action-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        #pedidos-pendentes-container h2 {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        .notification-badge {
            background: var(--color-danger);
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pedido-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid var(--color-light);
        }
        .pedido-item:last-child {
            border-bottom: none;
        }
        .pedido-item button {
            width: auto;
            padding: 8px 12px;
            font-size: 0.85rem;
        }

        /* --- MEDIA QUERIES --- */
        @media screen and (max-width: 1200px) {
            .container.visible {
                width: 94%;
                grid-template-columns: 7rem auto;
            }
            .auth-main-container {
                grid-template-columns: 40% 60%;
            }
            aside .logo h2 {
                display: none;
            }
            aside .sidebar h3 {
                display: none;
            }
            aside .sidebar a {
                width: 5.6rem;
            }
            aside .sidebar a:last-child {
                position: relative;
                margin-top: 1.8rem;
            }
            main .insights {
                grid-template-columns: 1fr;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media screen and (max-width: 768px) {
            .container.visible {
                width: 100%;
                grid-template-columns: 1fr;
                padding: 0 1rem;
            }
            .auth-main-container {
                grid-template-columns: 1fr;
            }
            .left-panel {
                display: none;
            }
            .auth-form-wrapper {
                box-shadow: none;
                padding: 1.5rem;
            }
            
            .card {
                padding: var(--padding-1);
            }

            aside {
                position: fixed;
                left: -100%;
                background: var(--color-white);
                width: 18rem;
                z-index: 3;
                box-shadow: 1rem 3rem 4rem var(--color-light);
                height: 100vh;
                padding-right: var(--card-padding);
                display: block;
                transition: left 400ms ease, background-color 0.3s ease;
            }

            aside.show-sidebar {
                left: 0;
            }

            aside .logo {
                margin-left: 1rem;
            }

            aside .logo h2 {
                display: inline;
            }

            aside .sidebar h3 {
                display: inline;
            }
            
            aside .sidebar a {
                width: 100%;
                height: 3.4rem;
            }

            aside .sidebar a:last-child {
                position: absolute;
                bottom: 5rem;
            }

            aside .close {
                display: inline-block;
                cursor: pointer;
            }

            main {
                margin-top: 0;
                padding: 0;
            }
            
            .top-bar {
                margin-top: 1.4rem;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                padding: 0 1rem;
                background: var(--color-background);
                z-index: 2;
                box-shadow: 0 1rem 1rem var(--color-light);
            }
            .dark-theme .top-bar {
                box-shadow: 0 1rem 1rem var(--color-light);
            }

            main .main-content {
                padding-top: 5rem;
            }

            #menu-btn {
                display: inline-block;
            }
            #mobile-page-title {
                display: inline-block;
            }

            .main-content > h1:not(#dashboard-title) {
                display: none;
            }
            
            .form-container {
                grid-template-columns: 1fr;
            }

            .table-wrapper {
                overflow-x: hidden;
            }

            table {
                white-space: normal;
            }

            table thead {
                display: none;
            }

            table tr {
                display: block;
                border: 1px solid var(--color-info-light);
                border-radius: var(--border-radius-2);
                padding: var(--padding-1);
                margin-bottom: 1rem;
            }

            table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid var(--color-light);
                padding: 10px 5px;
                text-align: right;
            }

            table td:last-child {
                border-bottom: none;
            }

            table td::before {
                content: attr(data-label);
                font-weight: bold;
                text-align: left;
                margin-right: 1rem;
                color: var(--color-primary);
            }

            .action-buttons {
                justify-content: flex-end;
            }
            
            .vencimento-proximo {
                border-color: var(--color-warning) !important;
            }
        }
    </style>
</head>
<body>
    
    <!-- ======================= AUTH PAGE ======================= -->
    <div id="auth-page" class="auth-main-container">
        <div class="left-panel">
            <div class="branding-content">
                <h1>Bem-vindo ao STOL<span class="danger">INX</span></h1>
                <p>Gerencie seu estoque de forma inteligente e eficiente, onde quer que você esteja.</p>
            </div>
        </div>
        <div class="right-panel">
            <div class="auth-form-wrapper">
                <div id="auth-message"></div>
                <form id="login-form">
                    <h1>Acesse sua Conta</h1>
                    <p>Bem-vindo de volta!</p>
                    <div class="input-group">
                        <input type="email" id="login-email" placeholder="Seu e-mail" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="login-password" placeholder="Sua senha" required>
                    </div>
                    <button type="submit">Entrar</button>
                    <a class="auth-toggle-link" id="forgot-password">Esqueceu a senha?</a>
                    <a class="auth-toggle-link" id="show-register">Não tem uma conta? Cadastre-se</a>
                </form>
                <form id="register-form">
                    <h1>Crie sua Conta</h1>
                    <p>É rápido e fácil.</p>
                    <div class="input-group">
                        <input type="email" id="register-email" placeholder="Seu e-mail" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="register-password" placeholder="Crie uma senha" required>
                    </div>
                    <button type="submit">Cadastrar</button>
                    <a class="auth-toggle-link" id="show-login">Já tem uma conta? Faça login</a>
                </form>
            </div>
        </div>
    </div>

    <!-- ======================= MAIN APP ======================= -->
    <div id="main-app" class="container">
        <!-- ========== ASIDE (SIDEBAR) ========== -->
        <aside>
            <div class="top">
                <div class="logo">
                    <h2>STOL<span class="danger">INX</span></h2>
                </div>
                <div class="close" id="close-btn">
                    <span class="material-icons-sharp">close</span>
                </div>
            </div>
            <div class="sidebar">
                <a href="#" class="nav-link" data-page="dashboard">
                    <span class="material-icons-sharp">grid_view</span>
                    <h3>Dashboard</h3>
                </a>
                <a href="#" class="nav-link" data-page="estoque">
                    <span class="material-icons-sharp">inventory_2</span>
                    <h3>Estoque</h3>
                </a>
                <a href="#" class="nav-link" data-page="vendas">
                    <span class="material-icons-sharp">receipt_long</span>
                    <h3>Vendas</h3>
                </a>
                <a href="#" id="theme-toggler-link">
                    <span class="material-icons-sharp">light_mode</span>
                    <h3>Tema</h3>
                </a>
                <a href="#" id="logout-btn">
                    <span class="material-icons-sharp">logout</span>
                    <h3>Sair</h3>
                </a>
            </div>
        </aside>
        
        <!-- ========== MAIN CONTENT ========== -->
        <main>
            <div class="top-bar">
                <div class="top-bar-left">
                    <button id="menu-btn">
                        <span class="material-icons-sharp">menu</span>
                    </button>
                    <h1 id="mobile-page-title">Dashboard</h1>
                </div>
            </div>

            <!-- ========== DASHBOARD PAGE ========== -->
            <div id="dashboard" class="main-content">
                <div class="dashboard-header">
                    <h1 id="dashboard-title">Dashboard</h1>
                    <div class="dashboard-filters">
                        <select id="filtro-mes"></select>
                        <select id="filtro-ano"></select>
                        <button id="export-dashboard-btn" title="Compartilhar Relatório">
                            <span class="material-icons-sharp">share</span>
                        </button>
                        <button id="export-pdf-btn" title="Baixar Relatório em PDF">
                            <span class="material-icons-sharp">picture_as_pdf</span>
                        </button>
                    </div>
                </div>
                <h2 id="welcome-message" class="text-muted" style="font-weight: 400; font-size: 1.2rem; margin-top: 0.5rem; margin-bottom: -0.5rem;"></h2>
                
                <div id="subscription-status">Carregando status da assinatura...</div>
                
                <div id="renewal-section" style="text-align: center; margin-bottom: 1.5rem;">
                    <button id="renew-subscription-btn" class="btn-success" style="padding: 12px 24px; font-size: 1rem;">
                        <span class="material-icons-sharp" style="vertical-align: middle;">credit_card</span> 
                        Renovar/Estender Assinatura (R$ 1,00)
                    </button>
                </div>

                <div class="insights">
                    <div class="sales">
                        <span class="material-icons-sharp">analytics</span>
                        <div class="middle">
                            <div>
                                <h3>Faturamento do Período</h3>
                                <h1 id="faturamento-mes">R$ 0,00</h1>
                            </div>
                        </div>
                        <small class="text-muted">Total de vendas no período</small>
                    </div>
                    <div class="expenses">
                        <span class="material-icons-sharp">bar_chart</span>
                        <div class="middle">
                            <div>
                                <h3>Investimento (Estoque Atual)</h3>
                                <h1 id="investimento-mes">R$ 0,00</h1>
                            </div>
                        </div>
                        <small class="text-muted">Custo total do estoque</small>
                    </div>
                    <div class="income">
                        <span class="material-icons-sharp">stacked_line_chart</span>
                        <div class="middle">
                            <div>
                                <h3>Lucro Potencial (Estoque Atual)</h3>
                                <h1 id="lucro-mes">R$ 0,00</h1>
                            </div>
                        </div>
                        <small class="text-muted">Lucro de todo o estoque</small>
                    </div>
                </div>

                <div class="dashboard-grid" style="margin-top: 1.5rem;">
                    <div class="card">
                        <h2>Vendas por Produto (Período)</h2>
                        <div class="chart-container">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2>Produtos com Mais Saída (Período)</h2>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Unidades Vendidas</th>
                                    </tr>
                                </thead>
                                <tbody id="produtos-mais-saida-body">
                                    <tr><td colspan="2">Nenhuma venda registrada.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== ESTOQUE PAGE ========== -->
            <div id="estoque" class="main-content">
                <h1>Gerenciar Estoque</h1>
                <div class="card">
                    <h2>Cadastrar Novo Item</h2>
                    <form class="form-container" id="form-cadastro-produto">
                        <input type="hidden" id="editProductId">
                        <div class="input-group">
                            <label for="codigoProduto">Código do Produto</label>
                            <input type="text" id="codigoProduto" placeholder="Ex: SB001" required>
                        </div>
                        <div class="input-group">
                            <label for="nomeProduto">Nome do Produto</label>
                            <input type="text" id="nomeProduto" placeholder="Ex: Sabonete Líquido" required>
                        </div>
                        <div class="input-group">
                            <label for="validade">Validade</label>
                            <input type="date" id="validade">
                        </div>
                        <div class="input-group">
                            <label for="quantidade">Quantidade</label>
                            <input type="number" id="quantidade" placeholder="Ex: 50" required>
                        </div>
                        <div class="input-group">
                            <label for="custoProduto">Custo do Produto</label>
                            <input type="text" class="currency" id="custoProduto" placeholder="Digite o valor" required>
                        </div>
                        <div class="input-group">
                            <label for="valorVenda">Valor de Venda</label>
                            <input type="text" class="currency" id="valorVenda" placeholder="Digite o valor" required>
                        </div>
                        <div class="input-group">
                            <label for="categoria">Categoria</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="categoria" style="flex-grow: 1;"></select>
                                <button type="button" id="open-category-modal" class="btn-warning" style="width: auto; padding: 0 15px;">
                                    <span class="material-icons-sharp">settings</span>
                                </button>
                            </div>
                        </div>
                        <div class="input-group" style="justify-content: flex-end;">
                            <button type="submit" class="btn-success">Cadastrar Produto</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h2>Itens em Estoque</h2>
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                        <input type="text" class="search-bar" id="searchEstoque" placeholder="Pesquisar..." style="margin-bottom: 0;">
                        <button id="export-estoque-pdf-btn" title="Baixar Relatório de Estoque em PDF" style="width: auto; flex-shrink: 0;">
                            <span class="material-icons-sharp">picture_as_pdf</span>
                        </button>
                    </div>
                    <small class="search-instruction">Busque por nome, código, "vencendo" ou "repor".</small>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Produto</th>
                                    <th>Qtd.</th>
                                    <th>Custo</th>
                                    <th>Venda</th>
                                    <th>Lucro/Un.</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-estoque-body"></tbody>
                        </table>
                    </div>
                    <div id="pagination-controls-estoque" class="pagination-container">
                        <button id="prev-page-estoque" class="pagination-button">&lt;&lt;</button>
                        <span id="page-info-estoque" class="page-info"></span>
                        <button id="next-page-estoque" class="pagination-button">&gt;&gt;</button>
                    </div>
                </div>
            </div>

            <!-- ========== VENDAS PAGE ========== -->
            <div id="vendas" class="main-content">
                <div id="pedidos-pendentes-container" class="card" style="display: none;">
                    <h2>Pedidos Pendentes
                        <span id="contador-pedidos" class="notification-badge">0</span>
                    </h2>
                    <div id="lista-pedidos-pendentes">
                        <p class="text-muted">Nenhum pedido pendente no momento.</p>
                    </div>
                </div>

                <h1>Registrar Venda / Orçamento</h1>
                <div class="card">
                    <h2>Itens e Cliente</h2>
                    <div class="form-container" id="form-vendas">
                        <div class="input-group">
                            <label for="nomeCliente">Nome do Cliente</label>
                            <input type="text" id="nomeCliente" placeholder="Opcional">
                        </div>
                        <div class="input-group">
                            <label for="telefoneCliente">Telefone do Cliente</label>
                            <input type="tel" id="telefoneCliente" placeholder="(xx) X xxxx-xxxx" maxlength="16">
                        </div>

                        <div class="input-group" style="grid-column: 1 / -1;">
                            <label for="pesquisaProdutoVenda">Adicionar Produto</label>
                            <div style="display: flex; gap: 1rem;">
                                <div style="flex-grow: 1; position: relative;">
                                    <input type="text" id="pesquisaProdutoVenda" placeholder="Digite para pesquisar um produto..." style="width: 100%;">
                                    <div id="sugestoes-produtos-container"></div>
                                </div>
                                <input type="number" id="quantidadeVenda" value="1" min="1" style="max-width: 100px;">
                            </div>
                        </div>

                        <div class="input-group" style="grid-column: 1 / -1;">
                            <button type="button" id="addItemOrcamento" style="width: auto; padding: 10px 30px;">Adicionar ao Orçamento</button>
                        </div>
                    </div>

                    <h2 style="margin-top: 2rem;">Orçamento Atual</h2>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Qtd.</th>
                                    <th>Preço Unit.</th>
                                    <th>Subtotal</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody id="orcamento-body"></tbody>
                        </table>
                    </div>

                    <div class="total-section">
                        <h3>Subtotal: <span id="subtotal-venda">R$ 0,00</span></h3>
                        
                        <div class="desconto-toggle-container">
                            <label style="font-weight: 500;">Tipo de Desconto:</label>
                            <div class="toggle-switch">
                                <button id="tipo-desconto-rs" class="toggle-btn active">R$</button>
                                <button id="tipo-desconto-porcento" class="toggle-btn">%</button>
                            </div>
                        </div>

                        <div id="desconto-rs-container" class="desconto-group">
                            <label for="descontoVenda">Desconto (R$):</label>
                            <input type="text" class="currency" id="descontoVenda" placeholder="0,00">
                        </div>
                        <div id="desconto-porcento-container" class="desconto-group" style="display: none;">
                            <label for="descontoPorcentagem">Desconto (%):</label>
                            <input type="number" id="descontoPorcentagem" placeholder="0">
                        </div>
                        <h1 class="total-final">Total: <span id="total-venda">R$ 0,00</span></h1>
                    </div>
                </div>

                <div class="card">
                    <h2>Finalizar</h2>
                    <div class="form-container">
                        <div class="input-group">
                            <label for="dataVenda">Data da Venda</label>
                            <input type="text" id="dataVenda" readonly>
                        </div>
                        <div class="input-group">
                            <label for="formaPagamento">Forma de Pagamento</label>
                            <select id="formaPagamento">
                                <option>Dinheiro</option><option>Pix</option><option>Crédito</option><option>Débito</option><option>Boleto</option><option>A Prazo</option>
                            </select>
                        </div>
                        <div class="input-group" style="grid-column: 1 / -1;">
                            <label>Ações</label>
                            <div class="action-buttons-grid">
                                <button type="button" id="share-pedido-link-btn" style="background: var(--color-primary);">
                                    <span class="material-icons-sharp">link</span> Enviar Link de Pedido
                                </button>
                                <button type="button" id="share-whatsapp" style="background-color: #25D366;">
                                    <span class="material-icons-sharp">share</span> Orçamento via WhatsApp
                                </button>
                                <button type="button" id="registrar-venda-btn" class="btn-success">
                                    <span class="material-icons-sharp">check_circle</span> Registrar Venda
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>Histórico de Vendas</h2>
                    <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 0.5rem; flex-wrap: wrap;">
                        <input type="text" class="search-bar" id="pesquisa-venda-cliente" placeholder="Pesquisar..." style="flex-grow: 1; margin-bottom: 0; min-width: 200px;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: nowrap;">
                            <input type="date" id="filtro-data-inicio" title="Data de início" style="padding: 8px; border-radius: var(--border-radius-1); background: var(--color-info-light); color: var(--color-dark);">
                            <span class="text-muted">até</span>
                            <input type="date" id="filtro-data-fim" title="Data de fim" style="padding: 8px; border-radius: var(--border-radius-1); background: var(--color-info-light); color: var(--color-dark);">
                            <button id="limpar-filtro-data" title="Limpar filtro de data" style="padding: 8px; width: auto; background: var(--color-dark-variant);"><span class="material-icons-sharp" style="font-size: 1.2rem; vertical-align: middle;">close</span></button>
                        </div>
                    </div>
                    <small class="search-instruction">Pesquise por nome, telefone ou filtre por um período.</small>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Telefone</th>
                                    <th>Data</th>
                                    <th>Itens Vendidos</th>
                                    <th>Forma Pag.</th>
                                    <th>Valor Total</th>
                                </tr>
                            </thead>
                            <tbody id="historico-vendas-body"></tbody>
                        </table>
                    </div>
                    <div id="pagination-controls-vendas" class="pagination-container">
                        <button id="prev-page-vendas" class="pagination-button">&lt;&lt;</button>
                        <span id="page-info-vendas" class="page-info"></span>
                        <button id="next-page-vendas" class="pagination-button">&gt;&gt;</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ======================= MODALS ======================= -->
    <div class="modal-overlay" id="app-notification-modal">
        <div class="modal-container" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="app-notification-title">Aviso</h2>
                <button class="close-modal" id="app-notification-close-btn"><span class="material-icons-sharp">close</span></button>
            </div>
            <div class="modal-body">
                <p id="app-notification-message" style="margin-bottom: 1.5rem;"></p>
                <div id="app-notification-buttons" style="display: flex; justify-content: flex-end; gap: 1rem;"></div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="category-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2>Gerenciar Categorias</h2>
                <button class="close-modal" id="close-category-modal"><span class="material-icons-sharp">close</span></button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="nova-categoria-nome">Adicionar Nova Categoria</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="nova-categoria-nome" placeholder="Nome da Categoria">
                        <button id="add-categoria-btn" class="btn-success" style="width: auto;">Adicionar</button>
                    </div>
                </div>
                <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Categorias Existentes</h3>
                <ul id="lista-categorias"></ul>
            </div>
        </div>
    </div>

    <!-- MUDANÇA: Modal para coletar dados do cliente antes do pagamento -->
    <div class="modal-overlay" id="payment-details-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2>Dados para Pagamento</h2>
                <button class="close-modal" id="close-payment-modal-btn"><span class="material-icons-sharp">close</span></button>
            </div>
            <div class="modal-body">
                <p class="text-muted" style="margin-bottom: 1.5rem;">Precisamos de alguns dados para gerar seu link de pagamento seguro.</p>
                <form id="payment-details-form">
                    <div class="input-group">
                        <label for="customer-name">Nome Completo</label>
                        <input type="text" id="customer-name" required>
                    </div>
                    <div class="input-group">
                        <label for="customer-email">E-mail</label>
                        <input type="email" id="customer-email" required>
                    </div>
                    <div class="input-group">
                        <label for="customer-cpf">CPF</label>
                        <input type="text" id="customer-cpf" placeholder="000.000.000-00" required>
                        <small id="cpf-error" style="color: var(--color-danger); display: none;">CPF inválido</small>
                    </div>
                    <div id="payment-form-buttons" style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;">
                         <button type="submit" class="btn-success">Gerar Link de Pagamento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- ======================= SCRIPTS ======================= -->
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app-check.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-functions.js"></script>
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => console.log('Service Worker registrado com sucesso:', registration))
                    .catch(error => console.log('Falha ao registrar o Service Worker:', error));
            });
        }
    </script>

    <!-- Main Application Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL CONFIG & VARIABLES ---
            const firebaseConfig = {
                apiKey: "AIzaSyAv54tgJ5oYrwTSNXpB2rCGjNbhJhe2CoM",
                authDomain: "stolinx-d6e26.firebaseapp.com",
                projectId: "stolinx-d6e26",
                storageBucket: "stolinx-d6e26.appspot.com",
                messagingSenderId: "715535971682",
                appId: "1:715535971682:web:66620d1590ae3e4ba6a83b"
            };

            firebase.initializeApp(firebaseConfig);
            const appCheck = firebase.appCheck();
            appCheck.activate('6LfxJ9YrAAAAAHldTMTw7pMA2PPiETNIh_VviK8V', true);

            const auth = firebase.auth();
            const db = firebase.firestore();
            const functions = firebase.functions();
            let currentUserId;
            let firestoreUnsubscribes = [];
            let salesChartInstance; 

            // DOM Elements
            const authPage = document.getElementById('auth-page');
            const mainAppPage = document.getElementById('main-app');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const authMessage = document.getElementById('auth-message');


            // =============================================================================
            // ============================ SHARED FUNCTIONS ===============================
            // =============================================================================

            function showAppNotification(message, title = 'Aviso') {
                const modal = document.getElementById('app-notification-modal');
                document.getElementById('app-notification-title').textContent = title;
                document.getElementById('app-notification-message').textContent = message;
                const buttonsContainer = document.getElementById('app-notification-buttons');
                buttonsContainer.innerHTML = '<button id="notification-ok-btn" class="btn-success">OK</button>';
                modal.style.display = 'flex';
                document.getElementById('notification-ok-btn').addEventListener('click', () => modal.style.display = 'none');
            }

            function showAppConfirmation(message, onConfirm, title = 'Confirmação') {
                const modal = document.getElementById('app-notification-modal');
                document.getElementById('app-notification-title').textContent = title;
                document.getElementById('app-notification-message').textContent = message;
                const buttonsContainer = document.getElementById('app-notification-buttons');
                buttonsContainer.innerHTML = `
                    <button id="confirmation-cancel-btn">Cancelar</button>
                    <button id="confirmation-ok-btn" class="btn-danger">Confirmar</button>
                `;
                modal.style.display = 'flex';
                document.getElementById('confirmation-ok-btn').addEventListener('click', () => {
                    if (typeof onConfirm === 'function') onConfirm();
                    modal.style.display = 'none';
                });
                document.getElementById('confirmation-cancel-btn').addEventListener('click', () => modal.style.display = 'none');
            }

            function formatCurrency(input) {
                let value = input.value.replace(/\D/g, '');
                if (value === "") {
                    input.value = "";
                    return;
                }
                value = (parseInt(value, 10) / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                input.value = value;
            }
            
            function getUserCollection(collectionName) {
                if (!currentUserId) throw new Error("Usuário não está logado!");
                return db.collection('users').doc(currentUserId).collection(collectionName);
            }

            function cleanupPageListeners() {
                if (salesChartInstance) {
                    salesChartInstance.destroy();
                    salesChartInstance = null;
                }
                firestoreUnsubscribes.forEach(unsubscribe => unsubscribe());
                firestoreUnsubscribes = [];
            }

            function validateCPF(cpf) {
                cpf = cpf.replace(/[^\d]+/g, '');
                if (cpf === '' || cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
                let add = 0;
                for (let i = 0; i < 9; i++) add += parseInt(cpf.charAt(i)) * (10 - i);
                let rev = 11 - (add % 11);
                if (rev === 10 || rev === 11) rev = 0;
                if (rev !== parseInt(cpf.charAt(9))) return false;
                add = 0;
                for (let i = 0; i < 10; i++) add += parseInt(cpf.charAt(i)) * (11 - i);
                rev = 11 - (add % 11);
                if (rev === 10 || rev === 11) rev = 0;
                if (rev !== parseInt(cpf.charAt(10))) return false;
                return true;
            }

            // =============================================================================
            // ============================= AUTHENTICATION ================================
            // =============================================================================

            function showAuthMessage(message, type = 'error') {
                authMessage.textContent = message;
                authMessage.className = type;
                authMessage.style.display = 'block';
            }

            document.getElementById('show-register').addEventListener('click', () => {
                loginForm.style.opacity = '0';
                loginForm.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    loginForm.style.display = 'none';
                    registerForm.style.display = 'block';
                    setTimeout(() => {
                        registerForm.style.opacity = '1';
                        registerForm.style.transform = 'scale(1)';
                    }, 50);
                    authMessage.style.display = 'none';
                }, 400);
            });

            document.getElementById('show-login').addEventListener('click', () => {
                registerForm.style.opacity = '0';
                registerForm.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    registerForm.style.display = 'none';
                    loginForm.style.display = 'block';
                    setTimeout(() => {
                        loginForm.style.opacity = '1';
                        loginForm.style.transform = 'scale(1)';
                    }, 50);
                    authMessage.style.display = 'none';
                }, 400);
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                if (!email || !password) {
                    showAuthMessage('Por favor, preencha todos os campos.');
                    return;
                }
                auth.signInWithEmailAndPassword(email, password)
                    .catch(error => {
                        console.error("Erro de Login:", error);
                        showAuthMessage("E-mail ou senha incorretos. Se não tiver uma conta, clique em 'Cadastre-se'.");
                    });
            });

            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                if (!email || !password) {
                    showAuthMessage('Por favor, preencha todos os campos.');
                    return;
                }
                auth.createUserWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        userCredential.user.sendEmailVerification();
                        return db.collection('users').doc(userCredential.user.uid).set({
                            email: userCredential.user.email,
                            active: false,
                            expiresAt: null
                        });
                    })
                    .then(() => {
                        showAuthMessage('Cadastro realizado! Verifique seu e-mail para ativar a conta e depois faça o login.', 'success');
                        setTimeout(() => document.getElementById('show-login').click(), 4000);
                    })
                    .catch(error => {
                        if (error.code === 'auth/email-already-in-use') {
                            document.getElementById('login-email').value = email;
                            document.getElementById('show-login').click();
                            setTimeout(() => showAuthMessage('Este e-mail já está cadastrado. Por favor, insira sua senha para entrar.'), 500);
                        } else {
                            let message = error.code === 'auth/weak-password' ? 'A senha deve ter pelo menos 6 caracteres.' : 'Ocorreu um erro ao criar a conta.';
                            showAuthMessage(message);
                        }
                    });
            });

            document.getElementById('forgot-password').addEventListener('click', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                if (!email) {
                    showAuthMessage('Por favor, digite seu e-mail no campo acima para redefinir a senha.');
                    return;
                }
                auth.sendPasswordResetEmail(email)
                    .then(() => showAuthMessage('E-mail de redefinição de senha enviado! Verifique sua caixa de entrada.', 'success'))
                    .catch(error => {
                        let message = error.code === 'auth/user-not-found' ? 'Nenhuma conta encontrada com este e-mail.' : 'Ocorreu um erro ao enviar o e-mail.';
                        showAuthMessage(message);
                    });
            });


            // =============================================================================
            // ========================== MAIN APP & NAVIGATION ============================
            // =============================================================================

            async function handleSubscriptionRenewal(customerData) {
                showAppNotification('Aguarde, estamos gerando seu link de pagamento...', 'Processando');
                try {
                    const createOrder = functions.httpsCallable('createPagbankOrderCallable');
                    const result = await createOrder(customerData); 
                    const paymentLink = result.data.paymentLink;
                    if (paymentLink) {
                        window.location.href = paymentLink;
                    } else {
                        throw new Error('Link de pagamento não recebido.');
                    }
                } catch (error) {
                    console.error("Erro ao criar pedido: ", error);
                    const errorMessage = error.details ? JSON.stringify(error.details) : error.message;
                    showAppNotification(`Erro ao gerar link: ${errorMessage}`);
                }
            }

            function setupCommonUI(user) {
                const menuBtn = document.getElementById('menu-btn');
                const closeBtn = document.getElementById('close-btn');
                const aside = document.querySelector('aside');
                const themeTogglerLink = document.getElementById('theme-toggler-link');
                const logoutBtn = document.getElementById('logout-btn');
                const welcomeMessageEl = document.getElementById('welcome-message');
                const notificationModal = document.getElementById('app-notification-modal');
                const categoryModal = document.getElementById('category-modal');

                if(menuBtn) menuBtn.addEventListener('click', () => aside.classList.add('show-sidebar'));
                if(closeBtn) closeBtn.addEventListener('click', () => aside.classList.remove('show-sidebar'));

                if (document.documentElement.classList.contains('dark-theme')) {
                    themeTogglerLink.querySelector('span').textContent = 'dark_mode';
                }
                themeTogglerLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.documentElement.classList.toggle('dark-theme');
                    const isDark = document.documentElement.classList.contains('dark-theme');
                    themeTogglerLink.querySelector('span').textContent = isDark ? 'dark_mode' : 'light_mode';
                    localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
                });

                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    cleanupPageListeners();
                    auth.signOut();
                });

                if (welcomeMessageEl) {
                    let userName = user.displayName || user.email.split('@')[0];
                    userName = userName.charAt(0).toUpperCase() + userName.slice(1);
                    welcomeMessageEl.textContent = `Olá, ${userName}`;
                }
                
                if(notificationModal) {
                    document.getElementById('app-notification-close-btn').addEventListener('click', () => notificationModal.style.display = 'none');
                    notificationModal.addEventListener('click', (e) => {
                        if (e.target === notificationModal) notificationModal.style.display = 'none';
                    });
                }
                if(categoryModal) {
                    document.getElementById('close-category-modal').addEventListener('click', () => categoryModal.style.display = 'none');
                     categoryModal.addEventListener('click', (e) => {
                        if (e.target === categoryModal) categoryModal.style.display = 'none';
                    });
                }

                // Lógica para o novo modal de pagamento
                const paymentModal = document.getElementById('payment-details-modal');
                const renewBtn = document.getElementById('renew-subscription-btn');
                const closePaymentBtn = document.getElementById('close-payment-modal-btn');
                const paymentForm = document.getElementById('payment-details-form');
                const customerCpfInput = document.getElementById('customer-cpf');
                const cpfError = document.getElementById('cpf-error');

                renewBtn.addEventListener('click', () => {
                    document.getElementById('customer-name').value = user.displayName || '';
                    document.getElementById('customer-email').value = user.email || '';
                    customerCpfInput.value = '';
                    paymentModal.style.display = 'flex';
                });

                closePaymentBtn.addEventListener('click', () => {
                    paymentModal.style.display = 'none';
                });
                
                paymentModal.addEventListener('click', (e) => {
                    if(e.target === paymentModal) paymentModal.style.display = 'none';
                });

                customerCpfInput.addEventListener('input', () => {
                    cpfError.style.display = 'none';
                    let value = customerCpfInput.value.replace(/\D/g, '');
                    value = value.slice(0, 11);
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                    customerCpfInput.value = value;
                });

                paymentForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const customerData = {
                        name: document.getElementById('customer-name').value,
                        email: document.getElementById('customer-email').value,
                        taxId: customerCpfInput.value.replace(/[^\d]+/g, '')
                    };

                    if (validateCPF(customerData.taxId)) {
                        cpfError.style.display = 'none';
                        paymentModal.style.display = 'none';
                        handleSubscriptionRenewal(customerData);
                    } else {
                        cpfError.style.display = 'block';
                    }
                });
            }

            function navigateToPage(pageId) {
                cleanupPageListeners();

                document.querySelectorAll('.main-content').forEach(content => content.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));

                const activeContent = document.getElementById(pageId);
                const activeLink = document.querySelector(`.nav-link[data-page="${pageId}"]`);

                if (activeContent) activeContent.classList.add('active');
                if (activeLink) activeLink.classList.add('active');
                document.getElementById('mobile-page-title').textContent = activeLink ? activeLink.querySelector('h3').textContent : 'Dashboard';

                // Call the specific init function for the page
                switch (pageId) {
                    case 'dashboard':
                        initDashboard();
                        break;
                    case 'estoque':
                        initEstoque();
                        break;
                    case 'vendas':
                        initVendas();
                        break;
                }
            }

            // =============================================================================
            // ============================ PAGE INITIALIZERS ==============================
            // =============================================================================
            
            function initDashboard() {
                console.log("Inicializando Dashboard...");
                const filtroMes = document.getElementById('filtro-mes');
                const filtroAno = document.getElementById('filtro-ano');
                const exportPdfBtn = document.getElementById('export-pdf-btn');
                const dashboardTitle = document.getElementById('dashboard-title');
                
                function displaySubscriptionStatus() {
                    if (!currentUserId) return;
                    const userRef = db.collection('users').doc(currentUserId);
                    const statusEl = document.getElementById('subscription-status');
                    const unsub = userRef.onSnapshot(doc => {
                        if (doc.exists) {
                            const userData = doc.data();
                            if (userData && userData.active && userData.expiresAt) {
                                const expiresDate = userData.expiresAt.toDate();
                                const now = new Date();
                                now.setHours(0, 0, 0, 0);
                                expiresDate.setHours(0, 0, 0, 0);

                                const diffTime = expiresDate.getTime() - now.getTime();
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                                let message = '';
                                if (diffDays > 7) message = `Sua assinatura expira em <span class="days-remaining primary">${diffDays} dias</span>.`;
                                else if (diffDays > 1) message = `Sua assinatura expira em <span class="days-remaining warning">${diffDays} dias</span>.`;
                                else if (diffDays === 1) message = `Sua assinatura expira <span class="days-remaining warning">amanhã</span>.`;
                                else if (diffDays === 0) message = `Sua assinatura expira <span class="days-remaining danger">hoje</span>.`;
                                else message = `<span class="days-remaining danger">Sua assinatura expirou.</span> Renove para continuar.`;
                                statusEl.innerHTML = message;
                            } else {
                                statusEl.innerHTML = `<span class="days-remaining danger">Sua conta não possui uma assinatura ativa.</span>`;
                            }
                        }
                    }, error => {
                        console.error("Erro ao ouvir status da assinatura:", error);
                        statusEl.textContent = 'Não foi possível carregar o status da assinatura.';
                    });
                    firestoreUnsubscribes.push(unsub);
                }
                
                function populateDateFilters() {
                    const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                    filtroMes.innerHTML = '<option value="all">Ano Inteiro</option>';
                    meses.forEach((mes, index) => filtroMes.innerHTML += `<option value="${index}">${mes}</option>`);
                    const anoAtual = new Date().getFullYear();
                    filtroAno.innerHTML = '';
                    for (let i = anoAtual; i >= anoAtual - 5; i--) filtroAno.innerHTML += `<option value="${i}">${i}</option>`;
                    filtroMes.value = new Date().getMonth();
                    filtroAno.value = anoAtual;
                }

                function atualizarDashboard() {
                    const ano = parseInt(filtroAno.value);
                    const mes = filtroMes.value;
                    const faturamentoEl = document.getElementById('faturamento-mes');
                    const investimentoEl = document.getElementById('investimento-mes');
                    const lucroEl = document.getElementById('lucro-mes');
                    const topSellersBody = document.getElementById('produtos-mais-saida-body');
                    
                    cleanupPageListeners();

                    const unsubEstoque = getUserCollection('produtos').onSnapshot(snapshot => {
                        let investimentoTotal = 0, lucroPotencialTotal = 0;
                        snapshot.forEach(doc => {
                            const p = doc.data();
                            investimentoTotal += (p.custo || 0) * (p.quantidade || 0);
                            lucroPotencialTotal += ((p.valorVenda || 0) - (p.custo || 0)) * (p.quantidade || 0);
                        });
                        investimentoEl.textContent = `R$ ${investimentoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                        lucroEl.textContent = `R$ ${lucroPotencialTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    });
                    firestoreUnsubscribes.push(unsubEstoque);

                    let primeiroDia, ultimoDia;
                    if (mes === 'all') {
                        primeiroDia = new Date(ano, 0, 1);
                        ultimoDia = new Date(ano, 11, 31, 23, 59, 59);
                        dashboardTitle.textContent = `Dashboard - Ano de ${ano}`;
                    } else {
                        primeiroDia = new Date(ano, parseInt(mes), 1);
                        ultimoDia = new Date(ano, parseInt(mes) + 1, 0, 23, 59, 59);
                        dashboardTitle.textContent = `Dashboard - ${filtroMes.options[filtroMes.selectedIndex].text} de ${ano}`;
                    }

                    const unsubVendas = getUserCollection('vendas').where('data', '>=', primeiroDia).where('data', '<=', ultimoDia)
                        .onSnapshot(snapshot => {
                            let faturamentoPeriodo = 0;
                            const topSellers = {};
                            snapshot.forEach(doc => {
                                const v = doc.data();
                                faturamentoPeriodo += v.total || 0;
                                if (v.itens) v.itens.forEach(item => topSellers[item.nome] = (topSellers[item.nome] || 0) + item.qtd);
                            });
                            faturamentoEl.textContent = `R$ ${faturamentoPeriodo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                            const sortedTopSellers = Object.entries(topSellers).sort((a, b) => b[1] - a[1]);
                            topSellersBody.innerHTML = sortedTopSellers.length === 0 ? '<tr><td colspan="2">Nenhuma venda no período.</td></tr>' : '';
                            if(sortedTopSellers.length > 0) {
                                sortedTopSellers.slice(0, 10).forEach(([nome, quantidade]) => {
                                    topSellersBody.innerHTML += `<tr><td>${nome}</td><td>${quantidade}</td></tr>`;
                                });
                            }
                            renderProductPieChart(sortedTopSellers);
                        });
                    firestoreUnsubscribes.push(unsubVendas);
                }
                
                function renderProductPieChart(topSellersData) {
                    const ctx = document.getElementById('salesChart').getContext('2d');
                    const labels = topSellersData.map(item => item[0]);
                    const data = topSellersData.map(item => item[1]);
                    if (salesChartInstance) salesChartInstance.destroy();
                    salesChartInstance = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Unidades Vendidas',
                                data: data,
                                backgroundColor: ['#009688', '#ff7782', '#ffbb55', '#41f1b6', '#7380ec', '#363949', '#a3a6ad'],
                                borderColor: [document.documentElement.classList.contains('dark-theme') ? '#202528' : '#fff'],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { 
                                    position: 'top',
                                    labels: {
                                        color: document.documentElement.classList.contains('dark-theme') ? '#edeffd' : '#363949'
                                    }
                                }
                            }
                        }
                    });
                }
                
                function exportDashboardPDF() { 
                    alert("Função de exportar PDF a ser implementada.");
                }

                displaySubscriptionStatus();
                populateDateFilters();
                atualizarDashboard();
                filtroMes.addEventListener('change', atualizarDashboard);
                filtroAno.addEventListener('change', atualizarDashboard);
                exportPdfBtn.addEventListener('click', exportDashboardPDF);
            }

            function initEstoque() { 
                // A lógica completa da página de estoque vai aqui...
                console.log("Inicializando Estoque (implementação completa necessária)...");
            }
            function initVendas() { 
                // A lógica completa da página de vendas vai aqui...
                console.log("Inicializando Vendas (implementação completa necessária)...");
            }


            // =============================================================================
            // ============================ APP ENTRY POINT ================================
            // =============================================================================
            
            auth.onAuthStateChanged(user => {
                if (user && user.emailVerified) {
                    currentUserId = user.uid;
                    const userRef = db.collection('users').doc(user.uid);
                    userRef.get().then(doc => {
                        if (doc.exists) {
                            authPage.classList.remove('visible');
                            mainAppPage.classList.add('visible');
                            
                            document.querySelectorAll('.nav-link').forEach(link => {
                                link.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    navigateToPage(link.dataset.page);
                                });
                            });
                            
                            setupCommonUI(user);
                            navigateToPage('dashboard');

                        } else {
                            userRef.set({ email: user.email, active: false, expiresAt: null })
                                .then(() => window.location.reload());
                        }
                    });
                } else {
                    if (user && !user.emailVerified) {
                        showAuthMessage('Por favor, verifique seu e-mail para continuar. Olhe sua caixa de entrada ou spam.');
                        auth.signOut();
                    }
                    authPage.classList.add('visible');
                    mainAppPage.classList.remove('visible');
                }
            });
        });
    </script>
</body>
</html>

